@{
    ViewData["Title"] = "TTTarantiruvannyaedition - –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä";
}

<div class="container">
    <h1>TTTarantiruvannyaedition</h1>
    
    <!-- –°—Ç—Ä–æ–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ -->
    <div class="connection-info">
        <label>–ê–¥—Ä–µ—Å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</label>
        <input type="text" id="connectionUrl" readonly>
        <button id="copyUrl">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="mainScreen">
        <div class="controls">
            <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã</h2>
            <div class="param-group">
                <label for="n">–®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è (n):</label>
                <input type="number" id="n" min="3" max="20" value="8" style="width: 80px; height: 30px; font-size: 16px;">
            </div>
            <div class="param-group">
                <label for="b">–í—ã—Å–æ—Ç–∞ –ø–æ–ª—è (b):</label>
                <input type="number" id="b" min="3" max="20" value="8" style="width: 80px; height: 30px; font-size: 16px;">
            </div>
            <div class="param-group">
                <label for="d">–®–∞–Ω—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (%):</label>
                <input type="number" id="d" min="0" max="100" value="15" style="width: 80px; height: 30px; font-size: 16px;">
            </div>
            <div class="param-group">
                <label for="t">–î–ª–∏–Ω–∞ –ª–∏–Ω–∏–∏ –¥–ª—è –ø–æ–±–µ–¥—ã:</label>
                <input type="number" id="t" min="3" max="10" value="5" style="width: 80px; height: 30px; font-size: 16px;">
            </div>
            <div class="param-group">
                <label for="u">–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞—Ö–≤–∞—Ç–∞ (—Ö–æ–¥–æ–≤):</label>
                <input type="number" id="u" min="1" max="10" value="3" style="width: 80px; height: 30px; font-size: 16px;">
            </div>
            
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –∏–≥—Ä—ã</h2>
            <div class="token-selection">
                <div class="token" style="background-color: #FF5252; width: 50px; height: 50px;" data-color="#FF5252"></div>
                <div class="token" style="background-color: #FFEB3B; width: 50px; height: 50px;" data-color="#FFEB3B"></div>
                <div class="token" style="background-color: #4CAF50; width: 50px; height: 50px;" data-color="#4CAF50"></div>
                <div class="token" style="background-color: #2196F3; width: 50px; height: 50px;" data-color="#2196F3"></div>
                <div class="token" style="background-color: #9C27B0; width: 50px; height: 50px;" data-color="#9C27B0"></div>
                <div class="token" style="background-color: #FF9800; width: 50px; height: 50px;" data-color="#FF9800"></div>
            </div>
            
            <div class="buttons">
                <button id="createLobby" style="padding: 15px 30px; font-size: 18px;">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
                <button id="showLobbies" style="padding: 15px 30px; font-size: 18px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ –ª–æ–±–±–∏ -->
    <div id="lobbiesScreen" style="display: none;">
        <div class="lobbies-section">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–æ–±–±–∏</h2>
            <div id="lobbiesList"></div>
            <button id="backToMain" style="padding: 10px 20px; margin-top: 15px;">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <!-- –í —ç–∫—Ä–∞–Ω–µ –ª–æ–±–±–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞ -->
<div id="lobbyScreen" style="display: none;">
    <div class="lobby-info">
        <h2>–õ–æ–±–±–∏ #<span id="lobbyIdDisplay"></span></h2>
        
        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ -->
        <div class="players-list" id="playersList">
            <h3>–ò–≥—Ä–æ–∫–∏ –≤ –ª–æ–±–±–∏:</h3>
            <ul id="players"></ul>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –ª–æ–±–±–∏) -->
        <div id="startGameSection" style="display: none; margin-top: 20px;">
            <button id="startGame" style="padding: 15px 30px; font-size: 18px; background: #28a745;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ª–æ–±–±–∏ -->
        <div style="margin-top: 20px;">
            <button id="leaveLobby" style="padding: 15px 30px; font-size: 18px; background: #dc3545;">–í—ã–π—Ç–∏ –∏–∑ –ª–æ–±–±–∏</button>
        </div>
    </div>
</div>

    <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
    <div id="gameScreen" style="display: none;">
        <div class="game-content">
            <div class="game-board" id="board"></div>
            <div class="status" id="status" style="font-size: 20px; padding: 15px;">–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</div>
            
            <div class="players-list">
                <h3>–ò–≥—Ä–æ–∫–∏:</h3>
                <ul id="gamePlayers"></ul>
            </div>
        </div>
    </div>
</div>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }
    
    .connection-info {
        margin: 20px 0;
        padding: 15px;
        background: #f0f8ff;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 16px;
    }
    
    .connection-info label {
        font-weight: bold;
        min-width: 180px;
    }
    
    #connectionUrl {
        flex: 1;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #ccc;
        border-radius: 6px;
        min-width: 300px;
    }
    
    #copyUrl {
        padding: 12px 25px;
        font-size: 16px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    
    .controls {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    .param-group {
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .param-group label {
        min-width: 220px;
        font-size: 16px;
        font-weight: bold;
    }
    
    .token-selection {
        display: flex;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .token {
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }
    
    .token.selected {
        border: 4px solid #000;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .buttons {
        margin: 25px 0;
        display: flex;
        gap: 20px;
    }
    
    .lobbies-section {
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 10px;
    }
    
    .lobby-info {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    .game-content {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    .game-board {
        margin: 25px 0;
        display: grid;
        gap: 4px;
        justify-content: center;
    }
    
    .cell {
        width: 60px;
        height: 60px;
        border: 2px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: white;
        position: relative;
        font-size: 20px;
        font-weight: bold;
        transition: all 0.2s;
    }
    
    .cell:hover {
        background: #f0f0f0;
    }
    
    .cell.blocked {
        background: #666;
        cursor: not-allowed;
    }
    
    .capture-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 6px;
        background: #4CAF50;
        width: 0%;
    }
    
    .players-list {
        margin-top: 25px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 10px;
    }
    
    .players-list h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
    }
    
    .players-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .players-list li {
        padding: 12px;
        margin: 8px 0;
        background: white;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 16px;
    }
    
    .player-color {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        border: 2px solid #ccc;
    }

    .lobby-item {
        padding: 15px;
        margin: 10px 0;
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .lobby-item:hover {
        border-color: #2196F3;
        transform: translateY(-2px);
    }

    .lobby-info-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .lobby-players {
        font-weight: bold;
        color: #2196F3;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Game script loaded');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const mainScreen = document.getElementById('mainScreen');
    const lobbiesScreen = document.getElementById('lobbiesScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen = document.getElementById('gameScreen');
    
    const nInput = document.getElementById('n');
    const bInput = document.getElementById('b');
    const dInput = document.getElementById('d');
    const tInput = document.getElementById('t');
    const uInput = document.getElementById('u');
    const createLobbyBtn = document.getElementById('createLobby');
    const showLobbiesBtn = document.getElementById('showLobbies');
    const backToMainBtn = document.getElementById('backToMain');
    const startGameBtn = document.getElementById('startGame');
    const boardElement = document.getElementById('board');
    const statusElement = document.getElementById('status');
    const tokenElements = document.querySelectorAll('.token');
    const playersListElement = document.getElementById('players');
    const gamePlayersElement = document.getElementById('gamePlayers');
    const connectionUrlInput = document.getElementById('connectionUrl');
    const copyUrlButton = document.getElementById('copyUrl');
    const lobbiesList = document.getElementById('lobbiesList');
    const startGameSection = document.getElementById('startGameSection');
    const lobbyIdDisplay = document.getElementById('lobbyIdDisplay');
    
    let selectedColor = null;
    let currentLobbyId = null;
    let currentGameId = null;
    let myColor = null;
    let isLobbyCreator = false;
    let pollInterval = null;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π URL
    const baseUrl = window.location.origin;
    connectionUrlInput.value = baseUrl;
    
    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ URL
    copyUrlButton.addEventListener('click', function() {
        connectionUrlInput.select();
        document.execCommand('copy');
        alert('URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–æ–∫–µ–Ω–∞
    tokenElements.forEach(token => {
        token.addEventListener('click', () => {
            tokenElements.forEach(t => t.classList.remove('selected'));
            token.classList.add('selected');
            selectedColor = token.getAttribute('data-color');
            console.log('Selected color:', selectedColor);
        });
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
    function showScreen(screenName) {
        console.log('Showing screen:', screenName);
        
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
        mainScreen.style.display = 'none';
        lobbiesScreen.style.display = 'none';
        lobbyScreen.style.display = 'none';
        gameScreen.style.display = 'none';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
        switch(screenName) {
            case 'main':
                mainScreen.style.display = 'block';
                statusElement.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏" –∏–ª–∏ "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"';
                break;
            case 'lobbies':
                lobbiesScreen.style.display = 'block';
                break;
            case 'lobby':
                lobbyScreen.style.display = 'block';
                if (currentLobbyId) {
                    lobbyIdDisplay.textContent = currentLobbyId;
                }
                break;
            case 'game':
                gameScreen.style.display = 'block';
                boardElement.style.display = 'grid';
                break;
        }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏
    createLobbyBtn.addEventListener('click', async () => {
        if (!selectedColor) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –∏–≥—Ä—ã!');
            return;
        }
        
        try {
            console.log('Creating lobby...');
            const params = {
                Width: parseInt(nInput.value),
                Height: parseInt(bInput.value),
                BlockChance: parseInt(dInput.value),
                WinLength: parseInt(tInput.value),
                CaptureProgress: parseInt(uInput.value)
            };
            
            const response = await fetch('/Game/CreateLobby', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            
            const result = await response.json();
            console.log('Create lobby result:', result);
            
            if (!result.success) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–±–±–∏: ' + result.error);
                return;
            }
            
            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É –ª–æ–±–±–∏
            console.log('Joining lobby:', result.lobbyId);
            const joinResponse = await fetch('/Game/JoinLobby', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    LobbyId: result.lobbyId,
                    Color: selectedColor,
                    Name: `–ò–≥—Ä–æ–∫ ${selectedColor}`
                })
            });
            
            const joinResult = await joinResponse.json();
            console.log('Join lobby result:', joinResult);
            
            if (joinResult.success) {
                currentLobbyId = result.lobbyId;
                myColor = selectedColor;
                isLobbyCreator = true;
                
                showScreen('lobby');
                statusElement.textContent = '–õ–æ–±–±–∏ —Å–æ–∑–¥–∞–Ω–æ! –û–∂–∏–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤...';
                connectionUrlInput.value = `${baseUrl}?lobbyId=${currentLobbyId}`;
                startGameSection.style.display = 'block';
                
                startLobbyPolling();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + joinResult.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–æ–±–±–∏');
        }
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ª–æ–±–±–∏
    showLobbiesBtn.addEventListener('click', async () => {
        try {
            console.log('Loading lobbies...');
            const response = await fetch('/Game/ListLobbies');
            const lobbies = await response.json();
            console.log('Lobbies:', lobbies);
            
            lobbiesList.innerHTML = '';
            
            if (lobbies.length === 0) {
                lobbiesList.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–æ–±–±–∏</p>';
            } else {
                lobbies.forEach(lobby => {
                    const lobbyItem = document.createElement('div');
                    lobbyItem.className = 'lobby-item';
                    lobbyItem.innerHTML = `
                        <div class="lobby-info-display">
                            <span>–õ–æ–±–±–∏ #${lobby.id} (${lobby.width}x${lobby.height})</span>
                            <span class="lobby-players">${lobby.playerCount}/6 –∏–≥—Ä–æ–∫–æ–≤</span>
                        </div>
                        <div>–ü–æ–±–µ–¥–∞: ${lobby.winLength} –≤ —Ä—è–¥, –ó–∞—Ö–≤–∞—Ç: ${lobby.captureProgress} —Ö–æ–¥–∞</div>
                    `;
                    
                    lobbyItem.addEventListener('click', () => joinExistingLobby(lobby.id));
                    lobbiesList.appendChild(lobbyItem);
                });
            }
            
            showScreen('lobbies');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ª–æ–±–±–∏:', error);
        }
    });
    
    // –ù–∞–∑–∞–¥ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
    backToMainBtn.addEventListener('click', () => {
        console.log('Returning to main menu');
        showScreen('main');
    });
    
    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ª–æ–±–±–∏
    async function joinExistingLobby(lobbyId) {
        if (!selectedColor) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç!');
            return;
        }
        
        try {
            console.log('Joining existing lobby:', lobbyId);
            const joinResponse = await fetch('/Game/JoinLobby', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    LobbyId: lobbyId,
                    Color: selectedColor,
                    Name: `–ò–≥—Ä–æ–∫ ${selectedColor}`
                })
            });
            
            const joinResult = await joinResponse.json();
            console.log('Join result:', joinResult);
            
            if (joinResult.success) {
                currentLobbyId = lobbyId;
                myColor = selectedColor;
                isLobbyCreator = false;
                
                showScreen('lobby');
                statusElement.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –ª–æ–±–±–∏! –û–∂–∏–¥–∞–µ–º –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...';
                startGameSection.style.display = 'none';
                
                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–æ–±–±–∏
                await updateLobbyState();
                startLobbyPolling();
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–æ–±–±–∏: ' + joinResult.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–æ–±–±–∏:', error);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–æ–±–±–∏
    async function updateLobbyState() {
        try {
            console.log('Updating lobby state...');
            const response = await fetch('/Game/LobbyState');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const lobbyData = await response.json();
            console.log('Lobby state:', lobbyData);
            
            if (lobbyData.error) {
                console.error('Lobby error:', lobbyData.error);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            updatePlayersList(lobbyData.players || []);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–æ–±–±–∏:', error);
        }
    }
    // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ª–æ–±–±–∏
const leaveLobbyBtn = document.getElementById('leaveLobby');
if (leaveLobbyBtn) {
    leaveLobbyBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/Game/LeaveLobby', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            if (result.success) {
                // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                await resetSession();
                showScreen('main');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ª–æ–±–±–∏:', error);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Å–µ—Å—Å–∏–∏
async function resetSession() {
    try {
        await fetch('/Game/ResetSession', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        // –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        currentLobbyId = null;
        currentGameId = null;
        myColor = null;
        isLobbyCreator = false;
        
        if (pollInterval) clearInterval(pollInterval);
        
        console.log('Session reset complete');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Å–µ—Å—Å–∏–∏:', error);
    }
}

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é

    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
    startGameBtn.addEventListener('click', async () => {
        try {
            console.log('Starting game...');
            const response = await fetch('/Game/StartGame', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ LobbyId: currentLobbyId })
            });
            
            const result = await response.json();
            console.log('Start game result:', result);
            
            if (result.success) {
                currentGameId = result.gameId;
                statusElement.textContent = '–ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!';
                
                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã
                showScreen('game');
                startGamePolling();
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã');
        }
    });
    
    // –û–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ª–æ–±–±–∏
    function startLobbyPolling() {
        if (pollInterval) clearInterval(pollInterval);
        
        console.log('Starting lobby polling');
        pollInterval = setInterval(async () => {
            try {
                console.log('Polling lobby state...');
                const response = await fetch('/Game/LobbyState');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const lobbyData = await response.json();
                console.log('Lobby poll result:', lobbyData);
                
                if (lobbyData.error) {
                    console.error('Lobby error:', lobbyData.error);
                    if (lobbyData.error.includes("not found") || lobbyData.error.includes("No lobby")) {
                        statusElement.textContent = "–õ–æ–±–±–∏ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ";
                        clearInterval(pollInterval);
                        showScreen('main');
                    }
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
                updatePlayersList(lobbyData.players || []);
                
                // –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å
                if (lobbyData.status === 'GameStarted' && lobbyData.gameId) {
                    console.log('Game started! Switching to game screen');
                    currentGameId = lobbyData.gameId;
                    clearInterval(pollInterval);
                    showScreen('game');
                    startGamePolling();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ –ª–æ–±–±–∏:', error);
            } if (lobbyData.error) {
    console.error('Lobby error:', lobbyData.error);
    if (lobbyData.error.includes("not found") || 
        lobbyData.error.includes("expired") ||
        lobbyData.error.includes("not in this lobby")) {
        statusElement.textContent = "–õ–æ–±–±–∏ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ –∏–ª–∏ –≤—ã –±—ã–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã";
        clearInterval(pollInterval);
        
        // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
        await resetSession();
        showScreen('main');
    }
    return;
}
        }, 2000);
        
    }
    
    // –û–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
    function startGamePolling() {
        if (pollInterval) clearInterval(pollInterval);
        
        console.log('Starting game polling');
        pollInterval = setInterval(async () => {
            try {
                console.log('Polling game state...');
                const response = await fetch('/Game/GameState');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const gameData = await response.json();
                console.log('Game poll result:', gameData);
                
                if (gameData.error) {
                    console.error('Game error:', gameData.error);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É
                updateBoard(gameData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                updateStatus(gameData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
                updateGamePlayersList(gameData.players || []);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ –∏–≥—Ä—ã:', error);
            }if (gameData.error) {
    console.error('Game error:', gameData.error);
    if (gameData.error.includes("not found") || 
        gameData.error.includes("expired") ||
        gameData.error.includes("not in this game")) {
        statusElement.textContent = "–ò–≥—Ä–∞ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ –≤—ã –±—ã–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã";
        clearInterval(pollInterval);
        
        // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é
        await resetSession();
        showScreen('main');
    }
    return;
}
        }, 2000);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –≤ –ª–æ–±–±–∏
    function updatePlayersList(players) {
        console.log('Updating players list:', players);
        playersListElement.innerHTML = '';
        
        if (players && players.length > 0) {
            players.forEach(player => {
                const li = document.createElement('li');
                
                const colorSpan = document.createElement('span');
                colorSpan.className = 'player-color';
                colorSpan.style.backgroundColor = player.color;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name || `–ò–≥—Ä–æ–∫ ${player.color}`;
                
                li.appendChild(colorSpan);
                li.appendChild(nameSpan);
                playersListElement.appendChild(li);
            });
        } else {
            playersListElement.innerHTML = '<li>–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ –ª–æ–±–±–∏</li>';
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ
    function updateGamePlayersList(players) {
        console.log('Updating game players list:', players);
        gamePlayersElement.innerHTML = '';
        
        if (players && players.length > 0) {
            players.forEach(player => {
                const li = document.createElement('li');
                
                const colorSpan = document.createElement('span');
                colorSpan.className = 'player-color';
                colorSpan.style.backgroundColor = player.color;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name || `–ò–≥—Ä–æ–∫ ${player.color}`;
                
                li.appendChild(colorSpan);
                li.appendChild(nameSpan);
                gamePlayersElement.appendChild(li);
            });
        } else {
            gamePlayersElement.innerHTML = '<li>–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</li>';
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–π –¥–æ—Å–∫–∏
    function updateBoard(gameData) {
        if (!gameData || !gameData.cells) {
            console.log('No game data for board update');
            return;
        }
        
        console.log('Updating game board');
        boardElement.innerHTML = '';
        const width = gameData.width || 5;
        const height = gameData.height || 5;
        
        boardElement.style.gridTemplateColumns = `repeat(${width}, 60px)`;
        
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const cellIndex = y * width + x;
                const cellData = gameData.cells[cellIndex];
                const cell = document.createElement('div');
                cell.className = 'cell' + (cellData?.blocked ? ' blocked' : '');
                cell.dataset.x = x;
                cell.dataset.y = y;
                
                if (cellData && !cellData.blocked && cellData.owner === null) {
                    cell.addEventListener('click', handleCellClick);
                }
                
                if (cellData && cellData.owner) {
                    const owner = gameData.players?.find(p => p.id === cellData.owner);
                    if (owner) {
                        cell.style.backgroundColor = owner.color;
                        cell.textContent = '‚úì';
                        cell.style.color = 'white';
                    }
                }
                
                const progressBar = document.createElement('div');
                progressBar.className = 'capture-progress';
                progressBar.style.width = cellData ? `${(cellData.progress / gameData.captureProgress) * 100}%` : '0%';
                cell.appendChild(progressBar);
                
                boardElement.appendChild(cell);
            }
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã
    function updateStatus(gameData) {
        if (!gameData) return;
        
        if (gameData.gameOver) {
            if (gameData.winner) {
                const winner = gameData.players?.find(p => p.id === gameData.winner);
                statusElement.textContent = winner ? `üéâ –ü–æ–±–µ–¥–∏–ª ${winner.name}! üéâ` : 'üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! üéâ';
                statusElement.style.background = '#d4edda';
                statusElement.style.color = '#155724';
            } else {
                statusElement.textContent = 'ü§ù –ù–∏—á—å—è!';
                statusElement.style.background = '#e2e3e5';
                statusElement.style.color = '#383d41';
            }
            clearInterval(pollInterval);
        } else if (gameData.players && gameData.players.length > 0) {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex || 0];
            if (currentPlayer) {
                statusElement.textContent = `üéÆ –•–æ–¥: ${currentPlayer.name}`;
                statusElement.style.background = '#d1ecf1';
                statusElement.style.color = '#0c5460';
                
                if (currentPlayer.color === myColor) {
                    statusElement.textContent += ' (–í–∞—à —Ö–æ–¥! üëÜ)';
                    statusElement.style.background = '#fff3cd';
                    statusElement.style.color = '#856404';
                }
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–ª–µ—Ç–∫–µ
    async function handleCellClick(e) {
        if (!currentGameId) return;
        
        const x = parseInt(e.target.dataset.x);
        const y = parseInt(e.target.dataset.y);
        
        try {
            console.log('Making move:', x, y);
            const response = await fetch('/Game/MakeMove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ X: x, Y: y })
            });
            
            const result = await response.json();
            console.log('Move result:', result);
            
            if (!result.success) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ö–æ–¥! ' + (result.error || ''));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ö–æ–¥–∞:', error);
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
    function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const lobbyId = urlParams.get('lobbyId');
        
        if (lobbyId) {
            connectionUrlInput.value = window.location.href;
            statusElement.textContent = '–ù–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–±–±–∏. –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    checkUrlParams();
    showScreen('main');
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
    });
});
resetSession();
</script>